<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!--LIVE_META-->
<title>Forja Observatory<!--LIVE_TITLE--></title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --bg: #0f172a; --surface: #1e293b; --border: #334155;
  --text: #e2e8f0; --dim: #94a3b8;
  --accent: #00E5B0; --success: #22c55e; --warning: #eab308; --error: #ef4444;
  --blue: #60a5fa; --purple: #a78bfa; --cyan: #22d3ee;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  background:var(--bg); color:var(--text); padding:24px; min-height:100vh; }
h1 { font-size:1.8rem; margin-bottom:4px;
  background:linear-gradient(135deg,var(--accent),var(--cyan));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.subtitle { color:var(--dim); margin-bottom:24px; font-size:.9rem; }

/* Zone 1: Executive Summary */
.summary { border-radius:12px; padding:20px 24px; margin-bottom:24px; }
.summary-live { background:linear-gradient(135deg,rgba(0,229,176,.12),rgba(34,211,238,.08));
  border:1px solid rgba(0,229,176,.3); }
.summary-static { background:var(--surface); border:1px solid var(--border); }
.summary-top { display:flex; align-items:center; gap:16px; flex-wrap:wrap; margin-bottom:12px; }
.summary-run { font-size:1.6rem; font-weight:800;
  background:linear-gradient(135deg,var(--accent),var(--cyan));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.summary-status { font-size:.85rem; padding:4px 12px; border-radius:6px; font-weight:600; }
.summary-sentence { font-size:1rem; color:var(--text); line-height:1.5; margin-bottom:12px; }
.summary-bar { height:6px; border-radius:3px; overflow:hidden; background:var(--border); }
.summary-bar-fill { height:100%; border-radius:3px; transition:width .3s; }
.live-dot { width:10px; height:10px; border-radius:50%; background:var(--accent);
  animation:pulse 1.5s ease-in-out infinite; flex-shrink:0; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }
.live-elapsed { font-family:monospace; color:var(--text); font-size:1rem;
  font-weight:600; margin-left:auto; }
.summary-agents { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
.summary-agent { background:var(--bg); border:1px solid var(--border); border-radius:8px;
  padding:6px 12px; display:flex; align-items:center; gap:8px; font-size:.82rem; }
.agent-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
.agent-dot.done { background:var(--success); }
.agent-dot.active { background:var(--accent); animation:pulse 1.5s ease-in-out infinite; }
.agent-dot.waiting { background:var(--border); }
.summary-fixes { background:var(--bg); border:1px solid var(--border); border-radius:8px;
  padding:14px 18px; margin-top:12px; }
.summary-fixes summary { font-size:.82rem; font-weight:600; color:var(--accent); cursor:pointer; }
.summary-fixes pre { font-size:.78rem; color:var(--dim); line-height:1.5; white-space:pre-wrap;
  margin:8px 0 0; font-family:inherit; }

/* Zone 2: Pipeline cards */
.section { margin-bottom:36px; }
.section-title { font-size:1.3rem; font-weight:700; margin-bottom:16px;
  padding-left:12px; border-left:3px solid var(--accent); color:var(--text); }
.pipeline { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:24px; }
.pipe-card { background:var(--surface); border:1px solid var(--border); border-radius:10px;
  padding:16px 20px; flex:1; min-width:180px; position:relative; overflow:hidden; }
.pipe-card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; }
.pipe-card.s-pass::before { background:var(--success); }
.pipe-card.s-warn::before { background:var(--warning); }
.pipe-card.s-fail::before { background:var(--error); }
.pipe-card.s-skip::before { background:var(--border); }
.pipe-card .pipe-name { font-size:.75rem; color:var(--dim); margin-bottom:6px;
  text-transform:uppercase; letter-spacing:.5px; }
.pipe-card .pipe-badge { display:inline-block; font-size:.65rem; font-weight:700;
  padding:2px 8px; border-radius:4px; margin-bottom:6px; text-transform:uppercase; }
.badge-pass { background:rgba(34,197,94,.15); color:var(--success); }
.badge-warn { background:rgba(234,179,8,.15); color:var(--warning); }
.badge-fail { background:rgba(239,68,68,.15); color:var(--error); }
.badge-skip { background:rgba(148,163,184,.1); color:var(--dim); }
.pipe-card .pipe-detail { font-size:.85rem; color:var(--text); }

/* Grid + panels */
.grid-2 { display:grid; grid-template-columns:repeat(auto-fit,minmax(420px,1fr)); gap:20px; }
.panel { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:20px; }
.panel h2 { font-size:1rem; color:var(--dim); margin-bottom:14px; border-bottom:1px solid var(--border);
  padding-bottom:8px; }
.panel canvas { max-height:300px; }

/* Mini stat cards */
.build-stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:10px; margin-bottom:20px; }
.mini-stat { background:var(--surface); border:1px solid var(--border); border-radius:8px;
  padding:12px; text-align:center; }
.mini-stat .val { font-size:1.4rem; font-weight:700; }
.mini-stat .lbl { color:var(--dim); font-size:.72rem; margin-top:2px; text-transform:uppercase; }
.mini-stat.accent .val { color:var(--accent); }
.mini-stat.green .val { color:var(--success); }
.mini-stat.blue .val { color:var(--blue); }

/* Tables */
table { width:100%; border-collapse:collapse; font-size:.83rem; }
th { text-align:left; padding:8px; border-bottom:2px solid var(--border); color:var(--dim);
  font-size:.72rem; text-transform:uppercase; letter-spacing:.5px; }
td { padding:8px; border-bottom:1px solid var(--border); }

/* Severity + tag badges */
.sev { display:inline-block; font-size:.65rem; font-weight:700; padding:2px 8px;
  border-radius:4px; text-transform:uppercase; min-width:55px; text-align:center; }
.sev-high { background:rgba(239,68,68,.15); color:var(--error); }
.sev-medium { background:rgba(234,179,8,.15); color:var(--warning); }
.sev-low { background:rgba(148,163,184,.1); color:var(--dim); }
.sev-product { background:rgba(96,165,250,.15); color:var(--blue); }
.tag { display:inline-block; font-size:.65rem; font-weight:700; padding:2px 8px;
  border-radius:4px; text-transform:uppercase; min-width:75px; text-align:center; }
.tag-FACT { background:rgba(34,197,94,.15); color:var(--success); }
.tag-DECISION { background:rgba(96,165,250,.15); color:var(--blue); }
.tag-ASSUMPTION { background:rgba(234,179,8,.15); color:var(--warning); }

/* Expert cards */
.experts { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:16px; }
.expert-card { background:var(--bg); border:1px solid var(--border); border-radius:8px;
  padding:14px; flex:1; min-width:200px; }
.expert-card .exp-name { font-weight:600; color:var(--accent); font-size:.9rem; }
.expert-card .exp-field { color:var(--dim); font-size:.78rem; margin:4px 0; }
.expert-card .exp-persp { font-size:.8rem; color:var(--text); opacity:.85; line-height:1.4; }

/* Outcome bar */
.progress-track { background:var(--border); border-radius:6px; height:24px; overflow:hidden; margin:8px 0; }
.progress-fill { height:100%; border-radius:6px; transition:width .3s; }
.progress-label { font-size:.8rem; color:var(--dim); margin-top:4px; }

/* Requirement lists */
.req-cols { display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-top:12px; }
.req-list { list-style:none; padding:0; }
.req-list li { padding:5px 0; font-size:.82rem; display:flex; align-items:flex-start; gap:6px; }
.req-list .icon-met { color:var(--success); flex-shrink:0; }
.req-list .icon-unmet { color:var(--error); flex-shrink:0; }
.req-list .icon-deferred { color:var(--blue); flex-shrink:0; }

/* Assumption density bar */
.density-bar { display:flex; height:28px; border-radius:6px; overflow:hidden; margin:8px 0; }
.density-bar .seg { display:flex; align-items:center; justify-content:center;
  font-size:.7rem; font-weight:600; color:#0f172a; }

/* Learnings list */
.learning-group { margin-bottom:16px; }
.learning-group h3 { font-size:.85rem; color:var(--accent); margin-bottom:8px;
  text-transform:capitalize; }
.learning-entry { padding:6px 0; font-size:.82rem; display:flex; gap:8px; align-items:flex-start;
  border-bottom:1px solid rgba(51,65,85,.5); }
.learning-entry:last-child { border-bottom:none; }

/* Workflow pipeline */
.wf-pipeline { display:flex; align-items:center; gap:0; flex-wrap:wrap; margin:12px 0; }
.wf-node { display:flex; flex-direction:column; align-items:center; min-width:100px;
  padding:12px 16px; background:var(--surface); border:2px solid var(--border);
  border-radius:10px; position:relative; }
.wf-node.wf-done { border-color:var(--success); }
.wf-node.wf-active { border-color:var(--accent); animation:pulse 1.5s ease-in-out infinite; }
.wf-node.wf-blocked { border-color:var(--warning); }
.wf-node .wf-order { font-size:.65rem; color:var(--dim); text-transform:uppercase; letter-spacing:.5px; }
.wf-node .wf-agent { font-size:.85rem; font-weight:600; margin:4px 0 2px; }
.wf-node .wf-output { font-size:.7rem; color:var(--dim); }
.wf-arrow { font-size:1.2rem; color:var(--border); margin:0 4px; flex-shrink:0; }

/* Collapsible zones */
details.zone { margin-bottom:36px; }
details.zone > summary { font-size:1.3rem; font-weight:700; margin-bottom:16px;
  padding-left:12px; border-left:3px solid var(--accent); color:var(--text);
  cursor:pointer; list-style:none; }
details.zone > summary::-webkit-details-marker { display:none; }
details.zone > summary::before { content:'▸ '; color:var(--accent); }
details.zone[open] > summary::before { content:'▾ '; }

/* CSS bar fallback (when Chart.js unavailable) */
.css-bar-row { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
.css-bar-label { width:90px; font-size:.78rem; color:var(--dim); text-align:right; flex-shrink:0; }
.css-bar-track { flex:1; height:20px; background:var(--border); border-radius:4px; overflow:hidden; display:flex; }
.css-bar-seg { height:100%; display:flex; align-items:center; justify-content:center;
  font-size:.65rem; font-weight:600; color:#0f172a; }

/* Footer */
.footer { text-align:center; color:var(--dim); font-size:.72rem; margin-top:40px;
  padding-top:16px; border-top:1px solid var(--border); }

@media (max-width:600px) {
  .grid-2 { grid-template-columns:1fr; }
  .pipeline { flex-direction:column; }
  .build-stats { grid-template-columns:repeat(2,1fr); }
  .req-cols { grid-template-columns:1fr; }
  body { padding:12px; }
}
</style>
</head>
<body>

<h1>Forja Observatory</h1>
<p class="subtitle">Full pipeline metrics dashboard</p>

<!-- All sections rendered by JS from embedded data -->
<div id="app"></div>

<script>
const D = /*DATA_JSON*/null;
const hasChartJS = typeof Chart !== 'undefined';

// ── Helpers ──
const esc = s => String(s).replace(/&/g,'&amp;').replace(/\x3c/g,'&lt;').replace(/>/g,'&gt;');
const sevClass = s => ({high:'sev-high',medium:'sev-medium',low:'sev-low'})[String(s).toLowerCase()]||'sev-low';
const badgeCls = s => s==='pass'?'badge-pass':s==='warn'?'badge-warn':s==='fail'?'badge-fail':'badge-skip';
const cardCls = s => s==='pass'?'s-pass':s==='warn'?'s-warn':s==='fail'?'s-fail':'s-skip';
const badgeText = s => s==='pass'?'PASS':s==='warn'?'WARN':s==='fail'?'FAIL':'SKIPPED';
const fmtTime = m => m>=60?Math.floor(m/60)+'h '+(m%60)+'m':m+'m';
const pctColor = p => p>=80?'var(--success)':p>=60?'var(--warning)':'var(--error)';
const cycleColor = c => c<=1?'#22c55e':c<=2?'#eab308':'#ef4444';

// ── Zone 1: Executive Summary ──
function buildSummary() {
  const runNum = D.iteration_number || 1;
  const total = D.total_features;
  const passed = D.total_passed;
  const blocked = D.total_blocked || 0;
  const pct = total > 0 ? Math.round(passed / total * 100) : 0;
  const tc = D.outcome_tech_coverage || 0;
  const isLive = D.live_mode;

  // Status
  let statusText, statusBg, statusColor;
  if (pct === 100) { statusText='ALL PASSED'; statusBg='rgba(34,197,94,.15)'; statusColor='var(--success)'; }
  else if (pct >= 50) { statusText='PARTIAL'; statusBg='rgba(234,179,8,.15)'; statusColor='var(--warning)'; }
  else if (total > 0) { statusText='NEEDS WORK'; statusBg='rgba(239,68,68,.15)'; statusColor='var(--error)'; }
  else { statusText='NO DATA'; statusBg='rgba(148,163,184,.1)'; statusColor='var(--dim)'; }

  const cls = isLive ? 'summary summary-live' : 'summary summary-static';
  let html = `<div class="${cls}">`;

  // Top row
  html += '<div class="summary-top">';
  if (isLive) html += '<div class="live-dot"></div>';
  html += `<span class="summary-run">${isLive?'LIVE — ':''}Run #${runNum}</span>`;
  html += `<span class="summary-status" style="background:${statusBg};color:${statusColor}">${statusText}</span>`;
  if (isLive) {
    const secs = D.elapsed_seconds;
    const h = Math.floor(secs/3600);
    const m = Math.floor((secs%3600)/60);
    const s = secs%60;
    const elapsed = h>0 ? `${h}h ${m}m ${s}s` : m>0 ? `${m}m ${s}s` : `${s}s`;
    html += `<span class="live-elapsed">${elapsed}</span>`;
  }
  html += '</div>';

  // Executive sentence
  if (total > 0) {
    let sentence = `${passed}/${total} features passed (${pct}%)`;
    if (D.outcome_status !== 'skip') sentence += `, coverage ${tc}%`;
    if (blocked > 0) sentence += `, ${blocked} blocked`;

    // Delta vs previous
    if (D.all_runs.length > 1) {
      const prev = D.all_runs[D.all_runs.length - 2];
      const curr = D.all_runs[D.all_runs.length - 1];
      const fd = curr.total_passed - prev.total_passed;
      const cd = curr.outcome_coverage - prev.outcome_coverage;
      const fs = fd >= 0 ? '+' : '';
      const cs = cd >= 0 ? '+' : '';
      sentence += `. Delta: <strong style="color:${fd>=0?'var(--success)':'var(--error)'}">${fs}${fd} features</strong>, <strong style="color:${cd>=0?'var(--success)':'var(--error)'}">${cs}${cd}% coverage</strong> vs Run #${runNum-1}`;
    } else {
      sentence += '. <span style="color:var(--dim)">Baseline run</span>';
    }
    html += `<div class="summary-sentence">${sentence}</div>`;

    // Full-width progress bar
    html += `<div class="summary-bar"><div class="summary-bar-fill" style="width:${pct}%;background:${pctColor(pct)}"></div></div>`;
  }

  // Agent activity row (live or with data)
  const tmKeys = Object.keys(D.per_teammate);
  if (tmKeys.length > 0) {
    html += '<div class="summary-agents">';
    for (const k of tmKeys) {
      const tm = D.per_teammate[k];
      const resolved = tm.passed + (tm.blocked||0);
      let dotCls, label;
      if (resolved === tm.total && tm.total > 0) { dotCls='done'; label=`${tm.passed}/${tm.total} done`; }
      else if (resolved > 0 || tm.failed > 0) { dotCls='active'; label=`${tm.passed}/${tm.total}`; }
      else { dotCls='waiting'; label='waiting'; }
      html += `<div class="summary-agent"><span class="agent-dot ${dotCls}"></span><strong>${esc(k)}</strong> <span style="color:var(--dim)">${label}</span></div>`;
    }
    html += '</div>';
  }

  // Next fixes (learnings manifest) — only show if available
  const manifest = D.learnings_manifest || '';
  if (manifest) {
    html += '<div class="summary-fixes"><details open>';
    html += '<summary>Next Fixes (Learnings Manifest)</summary>';
    html += `<pre>${esc(manifest)}</pre>`;
    html += '</details></div>';
  }

  html += '</div>';
  return html;
}

// ── Zone 2: Pipeline Status ──
function buildPipeline() {
  const phases = [
    {name:'Spec Review', status:D.sr_status,
      detail: D.sr_status!=='skip'
        ? `${D.sr_gaps} gaps found, ${D.sr_enrichments} enrichments added`
        : 'No data'},
    {name:'Plan Mode', status:D.plan_status,
      detail: D.plan_status!=='skip'
        ? `${D.plan_experts.length} experts, ${D.plan_answers.length} questions, ${D.plan_facts} FACT / ${D.plan_decisions} DECISION / ${D.plan_assumptions} ASSUMPTION`
        : 'Skipped'},
    {name:'Build', status:D.build_status,
      detail: D.build_status!=='skip'
        ? `${D.total_passed}/${D.total_features} passed` + (D.total_blocked > 0 ? `, ${D.total_blocked} blocked` : '') + `, ${D.num_teammates} teams, ${fmtTime(D.total_time_minutes)}`
        : 'No data'},
    {name:'Outcome', status:D.outcome_status,
      detail: D.outcome_status!=='skip'
        ? `Technical: ${D.outcome_tech_coverage}% coverage` + (D.outcome_deferred&&D.outcome_deferred.length>0?` | ${D.outcome_deferred.length} deferred`:'')
        : 'Skipped'},
    {name:'Learnings', status:D.learnings_status,
      detail: D.learnings_status!=='skip'
        ? `${D.learnings_total} total (${D.learnings_high} high, ${D.learnings_med} medium, ${D.learnings_low} low)`
        : 'None'},
  ];
  let html = '<div class="section"><div class="section-title">Pipeline Summary</div><div class="pipeline">';
  for (const p of phases) {
    html += `<div class="pipe-card ${cardCls(p.status)}">
      <div class="pipe-name">${p.name}</div>
      <span class="pipe-badge ${badgeCls(p.status)}">${badgeText(p.status)}</span>
      <div class="pipe-detail">${p.detail}</div>
    </div>`;
  }
  html += '</div>';
  // Outcome inline progress bar
  if (D.outcome_status !== 'skip') {
    const tc = D.outcome_tech_coverage;
    const deferredCount = (D.outcome_deferred||[]).length;
    html += `<div style="max-width:600px;margin:0 0 20px;">
      <div class="progress-track"><div class="progress-fill" style="width:${tc}%;background:${pctColor(tc)}"></div></div>
      <div class="progress-label">Technical coverage: ${tc}% &mdash; ${D.outcome_met.length} met, ${D.outcome_unmet.length} unmet${deferredCount>0?' | Product items deferred: '+deferredCount:''}</div>
    </div>`;
  }
  html += '</div>';
  return html;
}

// ── Workflow Pipeline (conditional) ──
function buildWorkflowPipeline() {
  const wp = D.workflow_phases || [];
  if (wp.length === 0) return '';
  // Count completion
  const done = wp.filter(p => p.status === 'done').length;
  const pct = wp.length > 0 ? Math.round(done / wp.length * 100) : 0;
  let html = '<div class="section"><div class="section-title">Workflow Pipeline</div>';
  html += `<div class="panel"><p style="color:var(--dim);font-size:.8rem;margin-bottom:12px">${done}/${wp.length} phases complete (${pct}%)</p>`;
  html += '<div class="wf-pipeline">';
  for (let i = 0; i < wp.length; i++) {
    const p = wp[i];
    const cls = p.status==='done'?'wf-done':p.status==='active'?'wf-active':p.status==='blocked'?'wf-blocked':'';
    const color = p.status==='done'?'var(--success)':p.status==='active'?'var(--accent)':p.status==='blocked'?'var(--warning)':'var(--dim)';
    const icon = p.status==='done'?'&#10003;':p.status==='active'?'&#9881;':p.status==='blocked'?'&#9888;':'&#9675;';
    html += `<div class="wf-node ${cls}">`;
    html += `<div class="wf-order">Phase ${p.order}</div>`;
    html += `<div class="wf-agent" style="color:${color}">${icon} ${esc(p.role || p.agent)}</div>`;
    html += `<div style="font-size:.7rem;color:var(--dim)">${esc(p.agent)}</div>`;
    if (p.output) html += `<div class="wf-output">${esc(p.output)}</div>`;
    html += '</div>';
    if (i < wp.length - 1) html += '<div class="wf-arrow">&#8594;</div>';
  }
  html += '</div></div></div>';
  return html;
}

// ── How to Run panel ──
function buildRunPanel() {
  if (!D.run_command) return '';
  const isWeb = D.project_type === 'web';
  const isCli = D.project_type === 'python-cli' || D.project_type === 'make';
  const icon = isWeb ? '&#127760;' : isCli ? '&#9654;' : '&#128187;';
  const label = D.run_label || 'Project';

  let html = '<div class="section"><div class="panel" style="border-left:3px solid var(--accent);padding:16px 20px">';
  html += `<div style="display:flex;justify-content:space-between;align-items:center">`;
  html += `<div>`;
  html += `<div style="font-size:.85rem;color:var(--dim);margin-bottom:4px">${icon} ${esc(label)}</div>`;
  html += `<div style="font-size:1.1rem;font-weight:700;color:var(--text)">How to Run</div>`;
  html += `</div>`;
  html += `<button onclick="navigator.clipboard.writeText('${D.run_command.replace(/'/g,"\\'")}');this.textContent='Copied!';setTimeout(()=>this.textContent='Copy',1500)" `
    + `style="background:var(--accent);color:#fff;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:.8rem;font-weight:600">Copy</button>`;
  html += `</div>`;
  html += `<code style="display:block;margin-top:10px;padding:10px 14px;background:var(--bg);border-radius:6px;font-size:.9rem;color:var(--accent);user-select:all">${esc(D.run_command)}</code>`;
  if (isCli) {
    html += `<div style="margin-top:8px;font-size:.78rem;color:var(--dim)">This is a terminal application. Open your terminal, <code>cd</code> to the project directory, and paste the command above.</div>`;
  }
  html += '</div></div>';
  return html;
}

// ── Zone 3: Build Details (collapsible, default open) ──
function buildBuildDetails() {
  // Don't render if no build data
  if (D.total_features === 0 && D.total_files === 0) return '';

  let html = '<details class="zone" open>';
  html += '<summary>Build Details</summary>';

  // Mini stat cards
  html += '<div class="build-stats">';
  html += `<div class="mini-stat green"><div class="val">${D.total_passed}/${D.total_features}</div><div class="lbl">Passed</div></div>`;
  if (D.total_blocked > 0) html += `<div class="mini-stat" style="border-color:#f59e0b"><div class="val" style="color:#f59e0b">${D.total_blocked}</div><div class="lbl">Blocked</div></div>`;
  html += `<div class="mini-stat accent"><div class="val">${D.avg_cycles}</div><div class="lbl">Avg Cycles</div></div>`;
  html += `<div class="mini-stat blue"><div class="val">${D.total_files}</div><div class="lbl">Total Files</div></div>`;
  html += `<div class="mini-stat blue"><div class="val">${D.total_lines.toLocaleString()}</div><div class="lbl">Lines of Code</div></div>`;
  html += `<div class="mini-stat accent"><div class="val">${D.total_commits}</div><div class="lbl">Commits</div></div>`;
  html += '</div>';

  // Charts: Features by Teammate + Cycles per Feature
  const tmKeys = Object.keys(D.per_teammate);
  if (tmKeys.length > 0) {
    html += '<div class="grid-2">';
    if (hasChartJS) {
      html += '<div class="panel"><h2>Features by Teammate</h2><canvas id="chartTeammate"></canvas></div>';
      html += '<div class="panel"><h2>Cycles per Feature</h2><canvas id="chartCycles"></canvas></div>';
    } else {
      // CSS fallback for Features by Teammate
      html += '<div class="panel"><h2>Features by Teammate</h2>';
      for (const k of tmKeys) {
        const tm = D.per_teammate[k];
        const total = tm.total || 1;
        const pP = Math.round(tm.passed/total*100);
        const pB = Math.round((tm.blocked||0)/total*100);
        const pF = 100 - pP - pB;
        html += `<div class="css-bar-row">
          <span class="css-bar-label">${esc(k)}</span>
          <div class="css-bar-track">
            ${pP>0?`<div class="css-bar-seg" style="width:${pP}%;background:#22c55e">${tm.passed}</div>`:''}
            ${pB>0?`<div class="css-bar-seg" style="width:${pB}%;background:#f59e0b">${tm.blocked||0}</div>`:''}
            ${pF>0?`<div class="css-bar-seg" style="width:${pF}%;background:#ef4444">${tm.failed}</div>`:''}
          </div>
        </div>`;
      }
      html += '</div>';
      // CSS fallback for Cycles per Feature
      html += '<div class="panel"><h2>Cycles per Feature</h2>';
      const maxC = Math.max(...D.feature_cycles.map(f=>f.cycles), 1);
      for (const f of D.feature_cycles.slice(0, 20)) {
        const w = Math.round(f.cycles/maxC*100);
        html += `<div class="css-bar-row">
          <span class="css-bar-label">${esc(f.id)}</span>
          <div class="css-bar-track">
            <div class="css-bar-seg" style="width:${w}%;background:${cycleColor(f.cycles)}">${f.cycles}</div>
          </div>
        </div>`;
      }
      html += '</div>';
    }
    html += '</div>';
  }

  // Code Generated table
  const exts = Object.entries(D.src_stats).sort((a,b)=>b[1].lines-a[1].lines);
  if (exts.length > 0) {
    html += '<div style="margin-top:20px"><div class="panel"><h2>Code Generated</h2><table>';
    html += '<thead><tr><th>Extension</th><th>Files</th><th>Lines</th></tr></thead><tbody>';
    for (const [ext, info] of exts) {
      html += `<tr><td>${esc(ext)}</td><td>${info.files}</td><td>${info.lines.toLocaleString()}</td></tr>`;
    }
    html += '</tbody></table></div></div>';
  }

  // Roadmap (merged from old buildRoadmap) — expandable feature cards
  const rm = D.roadmap || [];
  if (rm.length > 0) {
    html += '<div style="margin-top:20px"><div class="panel">';
    html += '<h2>Per-Teammate Features</h2>';
    for (const tm of rm) {
      const tmPct = tm.total > 0 ? Math.round(tm.passed/tm.total*100) : 0;
      html += `<div style="margin-bottom:18px">`;
      html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">`;
      html += `<span style="font-weight:600;color:var(--text)">${esc(tm.teammate)}</span>`;
      html += `<span style="font-size:.8rem;color:var(--dim)">${tm.passed}/${tm.total} (${tmPct}%)</span>`;
      html += `</div>`;
      for (const feat of tm.features) {
        const colors = {'passed':'#22c55e','failed':'#ef4444','blocked':'#f59e0b','pending':'#334155'};
        const bg = colors[feat.status] || '#334155';
        const textColor = feat.status === 'pending' ? 'var(--dim)' : '#fff';
        const cycles = feat.cycles || 0;
        const cycleLabel = cycles === 1 ? '1 cycle' : `${cycles} cycles`;
        html += `<details style="margin-bottom:4px;border-left:3px solid ${bg};padding-left:10px">`;
        html += `<summary style="cursor:pointer;list-style:none;display:flex;align-items:center;gap:8px;padding:4px 0">`;
        html += `<span style="background:${bg};color:${textColor};padding:2px 8px;border-radius:4px;font-size:.75rem;font-weight:600;white-space:nowrap">${esc(feat.id)}</span>`;
        html += `<span style="font-size:.8rem;color:var(--text);flex:1">${esc(feat.description)}</span>`;
        html += `<span style="font-size:.7rem;color:var(--dim);white-space:nowrap">${cycleLabel}</span>`;
        html += `</summary>`;
        html += `<div style="padding:6px 0 6px 20px;font-size:.78rem;color:var(--dim)">`;
        html += `<div>Status: <strong style="color:${bg}">${feat.status}</strong> &middot; ${cycleLabel}</div>`;
        if (feat.evidence) html += `<div style="margin-top:3px">Evidence: ${esc(feat.evidence)}</div>`;
        if (feat.created_at) html += `<div>Created: ${feat.created_at.slice(0,19)}</div>`;
        if (feat.passed_at) html += `<div>Passed: ${feat.passed_at.slice(0,19)}</div>`;
        if (feat.blocked_at) html += `<div>Blocked: ${feat.blocked_at.slice(0,19)}</div>`;
        html += `</div></details>`;
      }
      html += `</div>`;
    }
    html += '</div></div>';
  }

  html += '</details>';
  return html;
}

// ── Zone 4: Intelligence (collapsible) ──
function buildIntelligence() {
  const hasPlan = D.plan_status !== 'skip';
  const hasLearnings = Object.keys(D.learnings_by_cat).length > 0;
  const hasCrossmodel = D.crossmodel_issues.length > 0;
  const hasOutcome = D.outcome_status !== 'skip';

  // Don't render if nothing to show
  if (!hasPlan && !hasLearnings && !hasCrossmodel && !hasOutcome) return '';

  // Default collapsed on repeat runs, open on first
  const openAttr = D.all_runs.length <= 1 ? ' open' : '';
  let html = `<details class="zone"${openAttr}>`;
  html += '<summary>Intelligence</summary>';

  // Cross-Model Findings (moved from old Validation section)
  if (hasCrossmodel) {
    html += '<div class="panel" style="margin-bottom:20px"><h2>Cross-Model Findings</h2>';
    html += `<p style="color:var(--dim);font-size:.8rem;margin-bottom:10px">${D.crossmodel_issues.length} issues (${D.cm_high} high, ${D.cm_med} medium, ${D.cm_low} low)</p>`;
    html += '<table><thead><tr><th>Severity</th><th>File</th><th>Description</th></tr></thead><tbody>';
    for (const issue of D.crossmodel_issues.slice(0,20)) {
      const sev = (issue.severity||'low').toLowerCase();
      html += `<tr><td><span class="sev ${sevClass(sev)}">${sev.toUpperCase()}</span></td>`;
      html += `<td>${esc(issue.file||'?')}</td>`;
      html += `<td>${esc(issue.description||issue.message||'?')}</td></tr>`;
    }
    html += '</tbody></table></div>';
  }

  // Outcome Requirements (moved from old Validation section)
  if (hasOutcome) {
    html += '<div class="panel" style="margin-bottom:20px"><h2>Outcome Requirements</h2>';
    html += '<div class="req-cols">';
    html += '<div><h3 style="color:var(--success);font-size:.85rem;margin-bottom:8px">Met</h3><ul class="req-list">';
    if (D.outcome_met.length === 0) html += '<li style="color:var(--dim)">None</li>';
    for (const r of D.outcome_met.slice(0,15)) {
      html += `<li><span class="icon-met">&#10003;</span>${esc(r)}</li>`;
    }
    html += '</ul></div>';
    html += '<div><h3 style="color:var(--error);font-size:.85rem;margin-bottom:8px">Unmet (Technical)</h3><ul class="req-list">';
    if (D.outcome_unmet.length === 0) html += '<li style="color:var(--dim)">None</li>';
    for (const r of D.outcome_unmet.slice(0,15)) {
      html += `<li><span class="icon-unmet">&#10007;</span>${esc(r)}</li>`;
    }
    html += '</ul></div>';
    if (D.outcome_deferred && D.outcome_deferred.length > 0) {
      html += '<div><h3 style="color:var(--blue);font-size:.85rem;margin-bottom:8px">Deferred (Product)</h3><ul class="req-list">';
      for (const r of D.outcome_deferred.slice(0,15)) {
        html += `<li><span class="icon-deferred">&#9670;</span>${esc(r)}</li>`;
      }
      html += '</ul></div>';
    }
    html += '</div></div>';
  }

  // Plan Mode Expert Panel
  if (hasPlan) {
    html += '<div class="panel" style="margin-bottom:20px">';
    html += '<h2>Plan Mode &mdash; Expert Panel</h2>';
    html += '<div class="experts">';
    for (const exp of D.plan_experts.slice(0,3)) {
      html += `<div class="expert-card">
        <div class="exp-name">${esc(exp.name||'?')}</div>
        <div class="exp-field">${esc(exp.field||'')}</div>
        <div class="exp-persp">${esc(exp.perspective||'')}</div>
      </div>`;
    }
    html += '</div>';

    // Q&A table
    if (D.plan_answers.length > 0) {
      html += `<h3 style="font-size:.9rem;color:var(--dim);margin:14px 0 8px">Questions &amp; Answers (${D.plan_answers.length})</h3>`;
      html += '<table><thead><tr><th>Tag</th><th>Expert</th><th>Question</th><th>Answer</th></tr></thead><tbody>';
      for (const a of D.plan_answers) {
        const tag = a.tag||'?';
        html += `<tr><td><span class="tag tag-${tag}">${tag}</span></td>`;
        html += `<td>${esc(a.expert||'?')}</td>`;
        html += `<td>${esc(a.question||'?')}</td>`;
        html += `<td>${esc(String(a.answer||'').substring(0,150))}</td></tr>`;
      }
      html += '</tbody></table>';
    }

    // Assumption Density bar
    const total_qa = D.plan_facts + D.plan_decisions + D.plan_assumptions;
    if (total_qa > 0) {
      const pF = (D.plan_facts/total_qa*100).toFixed(0);
      const pD = (D.plan_decisions/total_qa*100).toFixed(0);
      const pA = (D.plan_assumptions/total_qa*100).toFixed(0);
      html += `<h3 style="font-size:.9rem;color:var(--dim);margin:14px 0 8px">Assumption Density</h3>`;
      html += `<div class="density-bar">`;
      if (D.plan_facts>0) html += `<div class="seg" style="width:${pF}%;background:var(--success)">${pF}% FACT</div>`;
      if (D.plan_decisions>0) html += `<div class="seg" style="width:${pD}%;background:var(--blue)">${pD}% DECISION</div>`;
      if (D.plan_assumptions>0) html += `<div class="seg" style="width:${pA}%;background:var(--warning)">${pA}% ASSUMPTION</div>`;
      html += '</div>';
    }
    html += '</div>';
  }

  // Learnings for next run
  if (hasLearnings) {
    html += '<div class="panel" style="margin-bottom:20px">';
    html += '<h2>Learnings for Next Run</h2>';
    const catKeys = Object.keys(D.learnings_by_cat);
    const techCats = catKeys.filter(c => c !== 'product-backlog');
    for (const cat of techCats) {
      html += `<div class="learning-group"><h3>${esc(cat)}</h3>`;
      for (const entry of D.learnings_by_cat[cat].slice(0,10)) {
        const sev = (entry.severity||'medium').toLowerCase();
        html += `<div class="learning-entry">
          <span class="sev ${sevClass(sev)}">${sev.toUpperCase()}</span>
          <span>${esc(entry.learning)}</span>
        </div>`;
      }
      html += '</div>';
    }
    const productItems = D.learnings_by_cat['product-backlog'] || [];
    if (productItems.length > 0) {
      html += '<div class="learning-group"><h3 style="color:var(--blue)">Product Backlog</h3>';
      for (const entry of productItems.slice(0,10)) {
        html += `<div class="learning-entry">
          <span class="sev sev-product">PRODUCT</span>
          <span>${esc(entry.learning)}</span>
        </div>`;
      }
      html += '</div>';
    }
    html += '</div>';
  }

  html += '</details>';
  return html;
}

// ── Zone 5: History (collapsible, only if >1 run) ──
function buildHistory() {
  if (!D.all_runs || D.all_runs.length <= 1) return '';

  let html = '<details class="zone">';
  html += '<summary>Run History</summary>';

  // Quality Over Time chart
  if (hasChartJS) {
    html += '<div class="panel" style="margin-bottom:20px"><h2>Quality Over Time</h2>';
    html += '<canvas id="chartDelta"></canvas></div>';
  } else {
    // CSS fallback
    html += '<div class="panel" style="margin-bottom:20px"><h2>Quality Over Time</h2>';
    const maxF = Math.max(...D.all_runs.map(r=>r.total_features), 1);
    for (let i = 0; i < D.all_runs.length; i++) {
      const r = D.all_runs[i];
      const wP = Math.round(r.total_passed/maxF*100);
      const wC = r.outcome_coverage;
      html += `<div class="css-bar-row">
        <span class="css-bar-label">#${i+1}</span>
        <div class="css-bar-track">
          <div class="css-bar-seg" style="width:${wP}%;background:#22c55e">${r.total_passed}p</div>
          <div class="css-bar-seg" style="width:${Math.max(100-wP,0)}%;background:transparent"></div>
        </div>
        <span style="font-size:.75rem;color:var(--dim);width:40px">${wC}%</span>
      </div>`;
    }
    html += '</div>';
  }

  // Run History table (compact — no delta column, the chart shows that)
  html += '<div class="panel"><table><thead><tr><th>Run</th><th>Time</th><th>Passed</th><th>Total</th><th>Coverage</th></tr></thead><tbody>';
  for (let i = D.all_runs.length - 1; i >= 0; i--) {
    const r = D.all_runs[i];
    const ts = r.timestamp ? r.timestamp.substring(0,16).replace('T',' ') : '?';
    html += `<tr><td>#${i+1}</td><td style="font-family:monospace;color:var(--dim)">${esc(ts)}</td>`;
    html += `<td>${r.total_passed}</td><td>${r.total_features}</td>`;
    html += `<td>${r.outcome_coverage}%</td></tr>`;
  }
  html += '</tbody></table></div>';

  html += '</details>';
  return html;
}

// ── Zone 6: Event Stream Timeline (collapsible) ──
function buildEventStream() {
  const events = D.event_stream || [];
  if (events.length === 0) return '';

  let html = '<details class="zone">';
  html += `<summary>Event Stream (${events.length} events)</summary>`;
  html += '<div class="panel"><table><thead><tr><th>Time</th><th>Type</th><th>Agent</th><th>Details</th></tr></thead><tbody>';

  // Show most recent events first, limit to 50
  const recent = events.slice(-50).reverse();
  for (const evt of recent) {
    const ts = evt.timestamp ? evt.timestamp.substring(11,19) : '?';
    const evtType = evt.type || '?';
    const agent = evt.agent || 'system';
    const data = evt.data || {};

    // Compact data display
    let details = '';
    if (evtType.startsWith('feature.')) {
      details = data.feature_id || '';
      if (data.cycle) details += ` (cycle ${data.cycle})`;
      if (data.evidence) details += ` - ${data.evidence.substring(0,30)}`;
      if (data.reason) details += ` - ${data.reason.substring(0,40)}`;
    } else if (evtType === 'context.set') {
      const val = typeof data.value === 'object' ? JSON.stringify(data.value).substring(0,30) : String(data.value || '').substring(0,30);
      details = `${data.key || '?'} = ${val}`;
    } else if (evtType === 'decision.logged') {
      details = `[${data.decision_type || '?'}] ${data.key || '?'}`;
    } else if (evtType === 'phase.complete') {
      details = `${data.phase || '?'}: ${data.success ? 'OK' : 'FAIL'}`;
    } else if (evtType.startsWith('monitor.')) {
      details = data.feature_id ? `${data.feature_id} (${data.stale_seconds || 0}s)` : `${data.reason || ''}`;
    } else if (evtType.startsWith('pipeline.')) {
      details = data.success !== undefined ? (data.success ? 'success' : 'failed') : (data.prd || '');
    } else {
      details = JSON.stringify(data).substring(0,50);
    }

    // Color-code by type
    let typeColor = 'var(--dim)';
    if (evtType.includes('passed') || evtType.includes('success')) typeColor = '#22c55e';
    else if (evtType.includes('failed') || evtType.includes('blocked') || evtType.includes('timeout')) typeColor = '#ef4444';
    else if (evtType.includes('stall') || evtType.includes('warn')) typeColor = '#f59e0b';
    else if (evtType.includes('decision')) typeColor = '#60a5fa';

    html += `<tr>
      <td style="font-family:monospace;color:var(--dim);white-space:nowrap">${esc(ts)}</td>
      <td style="color:${typeColor};font-weight:600;white-space:nowrap">${esc(evtType)}</td>
      <td style="color:var(--dim)">${esc(agent)}</td>
      <td>${esc(details)}</td>
    </tr>`;
  }

  html += '</tbody></table></div></details>';
  return html;
}

// ── Render all zones ──
const app = document.getElementById('app');
app.innerHTML = buildSummary() + buildPipeline() + buildRunPanel() + buildWorkflowPipeline()
  + buildBuildDetails() + buildIntelligence() + buildEventStream() + buildHistory()
  + `<div class="footer">Generated by Forja Observatory &mdash; <!--GENERATED_AT--></div>`;

// ── Charts (only if Chart.js loaded) ──
if (hasChartJS) {
  Chart.defaults.color = '#94a3b8';
  Chart.defaults.borderColor = '#334155';

  // Features by Teammate (stacked bar)
  const tmKeys = Object.keys(D.per_teammate);
  if (tmKeys.length > 0 && document.getElementById('chartTeammate')) {
    new Chart(document.getElementById('chartTeammate'), {
      type: 'bar',
      data: {
        labels: tmKeys,
        datasets: [
          { label: 'Passed', data: tmKeys.map(k=>D.per_teammate[k].passed), backgroundColor: '#22c55e' },
          { label: 'Blocked', data: tmKeys.map(k=>D.per_teammate[k].blocked||0), backgroundColor: '#f59e0b' },
          { label: 'Failed', data: tmKeys.map(k=>D.per_teammate[k].failed), backgroundColor: '#ef4444' }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'top' } },
        scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 } } }
      }
    });
  }

  // Cycles per Feature
  const fc = D.feature_cycles;
  if (fc.length > 0 && document.getElementById('chartCycles')) {
    new Chart(document.getElementById('chartCycles'), {
      type: 'bar',
      data: {
        labels: fc.map(f=>f.id),
        datasets: [{
          label: 'Cycles',
          data: fc.map(f=>f.cycles),
          backgroundColor: fc.map(f=>cycleColor(f.cycles))
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
      }
    });
  }

  // Quality Over Time (line chart)
  if (D.all_runs.length > 1 && document.getElementById('chartDelta')) {
    new Chart(document.getElementById('chartDelta'), {
      type: 'line',
      data: {
        labels: D.all_runs.map((r,i)=>`#${i+1} ${r.timestamp.substring(11,16)}`),
        datasets: [
          { label: 'Features Passed', data: D.all_runs.map(r=>r.total_passed),
            borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,.1)', fill: true,
            tension: 0.3, yAxisID: 'y' },
          { label: 'Outcome Coverage %', data: D.all_runs.map(r=>r.outcome_coverage),
            borderColor: '#60a5fa', backgroundColor: 'rgba(96,165,250,.1)', fill: true,
            tension: 0.3, yAxisID: 'y1' }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'top' } },
        scales: {
          y: { beginAtZero: true, position: 'left', title: { display: true, text: 'Features' } },
          y1: { beginAtZero: true, position: 'right', max: 100,
            title: { display: true, text: '%' }, grid: { drawOnChartArea: false } }
        }
      }
    });
  }
}
</script>
</body>
</html>
