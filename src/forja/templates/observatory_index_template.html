<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Forja Observatory - All Runs</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --bg: #0f172a; --surface: #1e293b; --border: #334155;
  --text: #e2e8f0; --dim: #94a3b8;
  --accent: #00E5B0; --success: #22c55e; --warning: #eab308; --error: #ef4444;
  --blue: #60a5fa; --purple: #a78bfa; --cyan: #22d3ee;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  background:var(--bg); color:var(--text); padding:24px; min-height:100vh; }
h1 { font-size:1.8rem; margin-bottom:4px;
  background:linear-gradient(135deg,var(--accent),var(--cyan));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.subtitle { color:var(--dim); margin-bottom:24px; font-size:.9rem; }

/* KPI Cards */
.kpi-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:12px; margin-bottom:28px; }
.kpi-card { background:var(--surface); border:1px solid var(--border); border-radius:10px;
  padding:16px 20px; text-align:center; position:relative; overflow:hidden; }
.kpi-card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; }
.kpi-card.kpi-accent::before { background:var(--accent); }
.kpi-card.kpi-green::before { background:var(--success); }
.kpi-card.kpi-blue::before { background:var(--blue); }
.kpi-card.kpi-cyan::before { background:var(--cyan); }
.kpi-card.kpi-purple::before { background:var(--purple); }
.kpi-card .kpi-val { font-size:1.8rem; font-weight:800; }
.kpi-card .kpi-lbl { color:var(--dim); font-size:.72rem; margin-top:4px; text-transform:uppercase; letter-spacing:.5px; }
.kpi-card.kpi-accent .kpi-val { color:var(--accent); }
.kpi-card.kpi-green .kpi-val { color:var(--success); }
.kpi-card.kpi-blue .kpi-val { color:var(--blue); }
.kpi-card.kpi-cyan .kpi-val { color:var(--cyan); }
.kpi-card.kpi-purple .kpi-val { color:var(--purple); }

/* Section titles */
.section { margin-bottom:32px; }
.section-title { font-size:1.2rem; font-weight:700; margin-bottom:16px;
  padding-left:12px; border-left:3px solid var(--accent); color:var(--text); }

/* Chart panels */
.chart-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(420px,1fr)); gap:20px; margin-bottom:28px; }
.panel { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:20px; }
.panel h2 { font-size:.95rem; color:var(--dim); margin-bottom:14px; border-bottom:1px solid var(--border);
  padding-bottom:8px; }
.panel canvas { max-height:260px; }

/* Run table */
table { width:100%; border-collapse:collapse; font-size:.83rem; }
th { text-align:left; padding:10px 8px; border-bottom:2px solid var(--border); color:var(--dim);
  font-size:.72rem; text-transform:uppercase; letter-spacing:.5px; cursor:pointer; user-select:none; }
th:hover { color:var(--accent); }
td { padding:10px 8px; border-bottom:1px solid var(--border); }
tr.run-row { cursor:pointer; transition:background .15s; }
tr.run-row:hover { background:rgba(0,229,176,.06); }

/* Status badges */
.badge { display:inline-block; font-size:.65rem; font-weight:700;
  padding:2px 8px; border-radius:4px; text-transform:uppercase; min-width:48px; text-align:center; }
.badge-pass { background:rgba(34,197,94,.15); color:var(--success); }
.badge-warn { background:rgba(234,179,8,.15); color:var(--warning); }
.badge-fail { background:rgba(239,68,68,.15); color:var(--error); }
.badge-skip { background:rgba(148,163,184,.1); color:var(--dim); }

/* Delta indicators */
.delta { font-size:.72rem; font-weight:600; margin-left:4px; }
.delta-pos { color:var(--success); }
.delta-neg { color:var(--error); }
.delta-zero { color:var(--dim); }

/* Sparkline bar */
.spark-bar { display:flex; height:14px; border-radius:3px; overflow:hidden; width:80px; }
.spark-bar .seg { height:100%; }
.spark-bar .seg-pass { background:var(--success); }
.spark-bar .seg-fail { background:var(--error); }
.spark-bar .seg-blocked { background:var(--warning); }

/* CSS bar fallback */
.css-bar-row { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
.css-bar-label { width:50px; font-size:.78rem; color:var(--dim); text-align:right; flex-shrink:0; }
.css-bar-track { flex:1; height:22px; background:var(--border); border-radius:4px; overflow:hidden; }
.css-bar-fill { height:100%; border-radius:4px; display:flex; align-items:center; justify-content:center;
  font-size:.65rem; font-weight:600; color:#0f172a; min-width:20px; }

/* Nav */
.nav-bar { display:flex; justify-content:flex-end; align-items:center; margin-bottom:8px; }
.nav-link { color:var(--accent); text-decoration:none; font-size:.85rem; font-weight:600; }
.nav-link:hover { text-decoration:underline; }

/* Empty state */
.empty-state { text-align:center; padding:60px 20px; color:var(--dim); }
.empty-state .empty-icon { font-size:3rem; margin-bottom:16px; }
.empty-state p { font-size:1rem; margin-bottom:8px; }

/* Footer */
.footer { text-align:center; color:var(--dim); font-size:.72rem; margin-top:40px;
  padding-top:16px; border-top:1px solid var(--border); }

@media (max-width:600px) {
  .chart-grid { grid-template-columns:1fr; }
  .kpi-row { grid-template-columns:repeat(2,1fr); }
  body { padding:12px; }
}
</style>
</head>
<body>

<div class="nav-bar">
  <a href="evals.html" class="nav-link">Latest Run &rarr;</a>
</div>

<h1>Forja Observatory</h1>
<p class="subtitle">All runs &middot; Generated <!--GENERATED_AT--></p>

<div id="app"></div>

<script>
const D = /*DATA_JSON*/null;
const hasChartJS = typeof Chart !== 'undefined';

if (!D || D.total_runs === 0) {
  document.getElementById('app').innerHTML = `
    <div class="empty-state">
      <div class="empty-icon">&#128301;</div>
      <p>No runs yet</p>
      <p style="font-size:.85rem">Run <code style="color:var(--accent)">forja run</code> to generate your first build.</p>
    </div>`;
} else {
  document.getElementById('app').innerHTML = buildKPIs() + buildCharts() + buildRunTable() + buildFooter();
  if (hasChartJS) initCharts();
}

function buildKPIs() {
  const avgTime = D.avg_build_time_minutes;
  const timeStr = avgTime >= 60 ? Math.floor(avgTime/60) + 'h ' + (avgTime%60) + 'm' : avgTime + 'm';
  return `
  <div class="kpi-row">
    <div class="kpi-card kpi-accent">
      <div class="kpi-val">${D.total_runs}</div>
      <div class="kpi-lbl">Total Runs</div>
    </div>
    <div class="kpi-card kpi-green">
      <div class="kpi-val">${D.total_features_shipped}</div>
      <div class="kpi-lbl">Features Shipped</div>
    </div>
    <div class="kpi-card kpi-blue">
      <div class="kpi-val">${D.overall_success_rate}%</div>
      <div class="kpi-lbl">Success Rate</div>
    </div>
    <div class="kpi-card kpi-cyan">
      <div class="kpi-val">${timeStr}</div>
      <div class="kpi-lbl">Avg Build Time</div>
    </div>
    <div class="kpi-card kpi-purple">
      <div class="kpi-val">${D.best_coverage}%</div>
      <div class="kpi-lbl">Best Coverage</div>
    </div>
  </div>`;
}

function buildCharts() {
  if (D.runs.length < 2) {
    return `<div class="section">
      <div class="section-title">Trends</div>
      <p style="color:var(--dim);font-size:.85rem;padding:12px">Run at least 2 builds to see trend charts.</p>
    </div>`;
  }

  // CSS fallback bars (shown when Chart.js unavailable)
  let cssFallback = '';
  if (!hasChartJS) {
    const maxFeat = Math.max(...D.features_per_run, 1);
    cssFallback = '<div class="panel"><h2>Features Per Run</h2>';
    D.runs.forEach(r => {
      const pct = Math.round(r.total_passed / maxFeat * 100);
      cssFallback += `<div class="css-bar-row">
        <span class="css-bar-label">#${r.index}</span>
        <div class="css-bar-track"><div class="css-bar-fill" style="width:${pct}%;background:var(--success)">${r.total_passed}</div></div>
      </div>`;
    });
    cssFallback += '</div>';
  }

  return `
  <div class="section">
    <div class="section-title">Trends</div>
    <div class="chart-grid">
      <div class="panel"><h2>Features Passed Per Run</h2><canvas id="chartFeatures"></canvas></div>
      <div class="panel"><h2>Coverage Over Time</h2><canvas id="chartCoverage"></canvas></div>
      <div class="panel"><h2>Cycle Efficiency</h2><canvas id="chartCycles"></canvas></div>
      <div class="panel"><h2>High-Severity Learnings</h2><canvas id="chartLearnings"></canvas></div>
    </div>
    ${!hasChartJS ? cssFallback : ''}
  </div>`;
}

function buildRunTable() {
  const runs = [...D.runs].reverse(); // newest first
  let rows = '';
  runs.forEach(r => {
    const ts = r.timestamp ? r.timestamp.slice(0, 16).replace('T', ' ') : '?';
    const statusClass = r.build_status === 'pass' ? 'badge-pass' :
                        r.build_status === 'warn' ? 'badge-warn' :
                        r.build_status === 'fail' ? 'badge-fail' : 'badge-skip';
    const statusLabel = r.build_status === 'pass' ? 'PASS' :
                        r.build_status === 'warn' ? 'WARN' :
                        r.build_status === 'fail' ? 'FAIL' : 'SKIP';

    // Feature ratio + sparkline
    const total = r.total_features || 1;
    const passW = Math.round(r.total_passed / total * 100);
    const blockW = Math.round(r.total_blocked / total * 100);
    const failW = 100 - passW - blockW;
    const spark = `<div class="spark-bar">
      <div class="seg seg-pass" style="width:${passW}%"></div>
      ${blockW > 0 ? `<div class="seg seg-blocked" style="width:${blockW}%"></div>` : ''}
      ${failW > 0 ? `<div class="seg seg-fail" style="width:${failW}%"></div>` : ''}
    </div>`;

    // Deltas
    const dp = r.delta_passed !== null ? deltaSpan(r.delta_passed) : '';
    const dc = r.delta_coverage !== null ? deltaSpan(r.delta_coverage, '%') : '';
    const dcy = r.delta_cycles !== null ? deltaSpan(r.delta_cycles, '', true) : '';

    const time = r.total_time_minutes >= 60
      ? Math.floor(r.total_time_minutes/60) + 'h ' + (r.total_time_minutes%60) + 'm'
      : r.total_time_minutes + 'm';

    const href = r.filename ? ` onclick="window.location.href='${r.filename}'"` : '';

    rows += `<tr class="run-row"${href}>
      <td><strong>#${r.index}</strong></td>
      <td>${ts}</td>
      <td><span class="badge ${statusClass}">${statusLabel}</span></td>
      <td>${r.total_passed}/${r.total_features} ${dp} ${spark}</td>
      <td>${r.outcome_tech_coverage}% ${dc}</td>
      <td>${r.avg_cycles.toFixed(1)} ${dcy}</td>
      <td>${time}</td>
      <td>${r.num_teammates}</td>
    </tr>`;
  });

  return `
  <div class="section">
    <div class="section-title">Run History</div>
    <div class="panel" style="overflow-x:auto">
      <table>
        <thead>
          <tr>
            <th>Run</th>
            <th>Timestamp</th>
            <th>Status</th>
            <th>Features</th>
            <th>Coverage</th>
            <th>Avg Cycles</th>
            <th>Time</th>
            <th>Agents</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  </div>`;
}

function deltaSpan(val, suffix, invertColor) {
  suffix = suffix || '';
  if (val === 0) return `<span class="delta delta-zero">0${suffix}</span>`;
  const isPositive = val > 0;
  // For cycles, lower is better (invert color)
  const cls = invertColor
    ? (isPositive ? 'delta-neg' : 'delta-pos')
    : (isPositive ? 'delta-pos' : 'delta-neg');
  const sign = isPositive ? '+' : '';
  return `<span class="delta ${cls}">${sign}${val}${suffix}</span>`;
}

function buildFooter() {
  return `<div class="footer">Forja Observatory &middot; <!--GENERATED_AT--> &middot; ${D.total_runs} run(s)</div>`;
}

function initCharts() {
  const labels = D.runs.map(r => '#' + r.index);
  const gridColor = 'rgba(51,65,85,.5)';
  const commonOptions = {
    responsive: true,
    plugins: { legend: { display: false } },
    scales: {
      x: { grid: { color: gridColor }, ticks: { color: '#94a3b8', font: { size: 11 } } },
      y: { grid: { color: gridColor }, ticks: { color: '#94a3b8', font: { size: 11 } }, beginAtZero: true }
    }
  };

  // Features chart
  new Chart(document.getElementById('chartFeatures'), {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        data: D.features_per_run,
        backgroundColor: D.features_per_run.map((v, i) => {
          const r = D.runs[i];
          return r && r.total_passed === r.total_features ? 'rgba(34,197,94,.7)' : 'rgba(234,179,8,.7)';
        }),
        borderRadius: 4,
      }]
    },
    options: { ...commonOptions, plugins: { ...commonOptions.plugins, tooltip: {
      callbacks: { label: ctx => {
        const r = D.runs[ctx.dataIndex];
        return `${r.total_passed}/${r.total_features} features passed`;
      }}
    }}}
  });

  // Coverage chart
  new Chart(document.getElementById('chartCoverage'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        data: D.coverage_trend,
        borderColor: '#60a5fa',
        backgroundColor: 'rgba(96,165,250,.1)',
        fill: true,
        tension: .3,
        pointRadius: 4,
        pointBackgroundColor: '#60a5fa',
      }]
    },
    options: { ...commonOptions, scales: {
      ...commonOptions.scales,
      y: { ...commonOptions.scales.y, max: 100, ticks: { ...commonOptions.scales.y.ticks, callback: v => v + '%' } }
    }}
  });

  // Cycles chart
  new Chart(document.getElementById('chartCycles'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        data: D.cycles_trend,
        borderColor: '#22d3ee',
        backgroundColor: 'rgba(34,211,238,.1)',
        fill: true,
        tension: .3,
        pointRadius: 4,
        pointBackgroundColor: '#22d3ee',
      }]
    },
    options: commonOptions
  });

  // Learnings chart
  new Chart(document.getElementById('chartLearnings'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        data: D.learnings_high_trend,
        borderColor: '#ef4444',
        backgroundColor: 'rgba(239,68,68,.1)',
        fill: true,
        tension: .3,
        pointRadius: 4,
        pointBackgroundColor: '#ef4444',
      }]
    },
    options: commonOptions
  });
}
</script>
</body>
</html>
